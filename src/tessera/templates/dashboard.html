{% extends "base.html" %}

{% block title %}Dashboard - Tessera{% endblock %}

{% block content %}
<section>
  <h2>Overview</h2>
  <div class="stats">
    <div class="stat">
      <div class="stat-value" id="stat-teams">-</div>
      <div class="stat-label">Teams</div>
    </div>
    <div class="stat">
      <div class="stat-value" id="stat-assets">-</div>
      <div class="stat-label">Assets</div>
    </div>
    <div class="stat">
      <div class="stat-value" id="stat-contracts">-</div>
      <div class="stat-label">Contracts</div>
    </div>
    <div class="stat">
      <div class="stat-value" id="stat-proposals">-</div>
      <div class="stat-label">Pending Proposals</div>
    </div>
  </div>
</section>

<section>
  <h2>Pending Proposals</h2>
  <div id="pending-proposals">
    <div class="loading">Loading...</div>
  </div>
</section>

<section>
  <h2>Recent Assets</h2>
  <div id="recent-assets">
    <div class="loading">Loading...</div>
  </div>
</section>
{% endblock %}

{% block scripts %}
<script>
async function loadDashboard() {
  try {
    // Load stats in parallel
    const [teams, assets, contracts, proposals] = await Promise.all([
      api.listTeams({ limit: 1 }),
      api.listAssets({ limit: 1 }),
      api.listContracts({ limit: 1 }),
      api.listProposals({ status: 'pending', limit: 1 }),
    ]);

    document.getElementById('stat-teams').textContent = teams.total || 0;
    document.getElementById('stat-assets').textContent = assets.total || 0;
    document.getElementById('stat-contracts').textContent = contracts.total || 0;
    document.getElementById('stat-proposals').textContent = proposals.total || 0;

    // Load pending proposals
    const pendingProposals = await api.listProposals({ status: 'pending', limit: 5 });
    const proposalsContainer = document.getElementById('pending-proposals');

    if (!pendingProposals.results || pendingProposals.results.length === 0) {
      proposalsContainer.innerHTML = '<div class="empty">No pending proposals</div>';
    } else {
      proposalsContainer.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>Asset</th>
              <th>Change Type</th>
              <th>Breaking Changes</th>
              <th>Acknowledgments</th>
              <th>Created</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            ${pendingProposals.results.map(p => `
              <tr>
                <td><a href="/assets/${p.asset_id}">${escapeHtml(p.asset_fqn || p.asset_id)}</a></td>
                <td><span class="status status-${p.change_type === 'major' ? 'deprecated' : 'active'}">${escapeHtml(p.change_type || 'unknown')}</span></td>
                <td>${p.breaking_changes_count || 0}</td>
                <td>
                  ${p.total_consumers > 0
                    ? `<span style="color: ${p.acknowledgment_count >= p.total_consumers ? 'green' : 'orange'};">${p.acknowledgment_count || 0}/${p.total_consumers}</span>`
                    : '<span style="color: var(--gray);">N/A</span>'
                  }
                </td>
                <td>${formatDate(p.proposed_at)}</td>
                <td><a href="/proposals/${p.id}">View</a></td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }

    // Load recent assets
    const recentAssets = await api.listAssets({ limit: 5 });
    const assetsContainer = document.getElementById('recent-assets');

    if (!recentAssets.results || recentAssets.results.length === 0) {
      assetsContainer.innerHTML = '<div class="empty">No assets found</div>';
    } else {
      assetsContainer.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>FQN</th>
              <th>Owner</th>
              <th>Active Contract</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            ${recentAssets.results.map(a => `
              <tr>
                <td><a href="/assets/${a.id}">${escapeHtml(a.fqn)}</a></td>
                <td><a href="/teams/${a.owner_team_id}">${escapeHtml(a.owner_team_name || a.owner_team_id)}</a></td>
                <td>${a.active_contract_version ? `<span class="status status-active">${escapeHtml(a.active_contract_version)}</span>` : '<span style="color: var(--gray);">None</span>'}</td>
                <td><a href="/assets/${a.id}">View</a></td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
    }
  } catch (error) {
    showError(error.message);
  }
}

loadDashboard();
</script>
{% endblock %}
